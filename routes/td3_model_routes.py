"""
TD3模型和结果管理相关路由
"""
from flask import jsonify
import json
import os
from routes.td3_config import RESULTS_DIR, TRAINING_DATA_DIR
from routes.model_management import get_models_list, get_results_list


def get_td3_models():
    """获取可用的TD3模型列表"""
    return get_models_list(TRAINING_DATA_DIR)


def get_td3_results():
    """获取TD3优化结果列表"""
    return get_results_list(RESULTS_DIR)


def get_td3_result_detail(filename):
    """获取TD3优化结果详情"""
    try:
        result_file = os.path.join(RESULTS_DIR, filename)
        if not os.path.exists(result_file):
            return jsonify({
                'status': 'error',
                'message': '结果文件不存在'
            }), 404
        
        with open(result_file, 'r', encoding='utf-8') as f:
            result_data = json.load(f)
        
        return jsonify({
            'status': 'success',
            'data': result_data
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'获取结果详情失败: {str(e)}'
        }), 500


def get_td3_template():
    """获取TD3优化示例数据模板"""
    try:
        template = {
            'busData': [
                [1, 0, 0], [2, 0, 0], [3, 0, 0], [4, 0, 0], [5, 0, 0],
                [6, 0, 0], [7, 0, 0], [8, 0, 0], [9, 0, 0], [10, 0, 0],
                [11, 0.325071, -0.023704], [12, 0, 0], [13, -0.02834, 0],
                [14, 0.20565, 0.00301], [15, 0, 0], [16, -0.067145, 0],
                [17, 0.095275, 0.00102], [18, 0, 0], [19, -0.09425, 0],
                [20, 0.24197, 0.02307], [21, 0, 0], [22, -0.052715, 0],
                [23, 0.214965, 0.05159], [24, 0, 0], [25, -0.1508, 0],
                [26, 0.231172, 0.007432], [27, 0.121383, 0.02996], [28, 0, 0],
                [29, -0.47385, 0], [30, 0.648046, 0.163962], [31, 0, 0],
                [32, 0.01908, 0.00991], [33, -0.6704, 0.0386], [34, -1.205, 0.414]
            ],
            'branchData': [
                [1, 1, 2, 0.3436, 0.8136], [2, 2, 3, 0.0341, 0.0807],
                [3, 3, 4, 0.0369, 0.0874], [4, 4, 5, 0.0426, 0.1009],
                [5, 5, 6, 0.0852, 0.2017], [6, 6, 7, 0.4885, 1.1565],
                [7, 7, 8, 0.7128, 1.6877], [8, 8, 9, 0.3280, 0.7766],
                [9, 9, 10, 0.3124, 0.7396], [10, 10, 11, 0.4686, 1.1095],
                [11, 2, 12, 0.2456, 0.1778], [12, 12, 13, 0.0238, 0.0172],
                [13, 12, 14, 0.0238, 0.0172], [14, 3, 15, 0.0475, 0.0344],
                [15, 15, 16, 0.0238, 0.0172], [16, 15, 17, 0.0238, 0.0172],
                [17, 4, 18, 0.4275, 0.3096], [18, 18, 19, 0.0238, 0.0172],
                [19, 18, 20, 0.0238, 0.0172], [20, 5, 21, 0.2233, 0.1617],
                [21, 21, 22, 0.0238, 0.0172], [22, 21, 23, 0.0238, 0.0172],
                [23, 6, 24, 0.4275, 0.3096], [24, 24, 25, 0.02375, 0.0172],
                [25, 24, 26, 0.02375, 0.0172], [26, 7, 27, 0.35625, 0.258],
                [27, 8, 28, 0.4061, 1.0168], [28, 28, 29, 0.02375, 0.0172],
                [29, 28, 30, 0.02375, 0.0172], [30, 9, 31, 0.475, 0.344],
                [31, 31, 32, 0.02375, 0.0172], [32, 31, 33, 0.02375, 0.0172],
                [33, 10, 34, 0.16625, 0.1204]
            ],
            'voltageLimits': [9.5, 10.5],
            'keyNodes': [0, 1, 2, 3, 4],
            'tunableNodes': [
                [32, -0.3, 0.3, "节点33"],
                [33, -0.5, 0.5, "节点34"]
            ],
            'modelPath': 'M1_1229_230322.pth',
            'parameters': {
                'UB': 10.38,
                'SB': 10
            }
        }
        
        return jsonify({
            'status': 'success',
            'data': template
        })
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'获取TD3模板失败: {str(e)}'
        }), 500

